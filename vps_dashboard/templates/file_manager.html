<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #555; }
        .nav-buttons { margin-bottom: 1em; }
        .nav-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: #007bff; color: white; margin-right: 10px; }
        .nav-buttons button:hover { background-color: #0056b3; }
        .file-actions { margin-bottom: 1em; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .file-actions input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .file-actions button, .file-actions input[type="file"] { padding: 8px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; }
        .file-actions button:hover { background-color: #0056b3; }
        .file-actions input[type="file"] { background-color: #28a745; }
        .file-actions input[type="file"]:hover { background-color: #218838; }

        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        .file-item-name a { text-decoration: none; color: #007bff; }
        .file-item-name a:hover { text-decoration: underline; }
        .action-buttons button { margin-right: 5px; padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer; }
        .action-buttons button:hover { background-color: #e0e0e0; }
        .action-buttons .delete-btn { background-color: #dc3545; color: white; border-color: #dc3545; }
        .action-buttons .delete-btn:hover { background-color: #c82333; }
        .current-path { font-size: 1.2em; margin-bottom: 1em; }

        #bookmarks { margin-bottom: 1em; padding-bottom: 1em; border-bottom: 1px solid #ddd; }
        .bookmark-item { display: inline-block; margin-right: 10px; background: #e0e0e0; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }
        .bookmark-item a { text-decoration: none; color: #333; }
        .bookmark-item .delete-bookmark { color: #999; cursor: pointer; margin-left: 8px; font-weight: bold; }
        .bookmark-item .delete-bookmark:hover { color: #f00; }

        .pagination {
            margin-top: 1em;
            text-align: center;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            background-color: #eee;
        }
        .pagination span {
            margin: 0 1em;
        }

        /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
        .modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 1; /* ä½äºé¡¶éƒ¨ */
            left: 0;
            top: 0;
            width: 100%; /* æ»¡å®½ */
            height: 100%; /* æ»¡é«˜ */
            overflow: auto; /* å¦‚æœå†…å®¹è¿‡å¤šï¼Œå…è®¸æ»šåŠ¨ */
            background-color: rgba(0,0,0,0.4); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* è·é¡¶éƒ¨15%ï¼Œæ°´å¹³å±…ä¸­ */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* å®½åº¦ */
            max-width: 800px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* ç¼–è¾‘å™¨æ¨¡æ€æ¡†æ ·å¼ */
        #editor-textarea {
            width: 100%;
            height: 400px;
            font-family: monospace;
            font-size: 0.9em;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* åŒ…å«paddingå’Œborderåœ¨å®½åº¦å†… */
            resize: vertical; /* å…è®¸å‚ç›´è°ƒæ•´å¤§å° */
        }
        .editor-buttons {
            margin-top: 1em;
            text-align: right;
        }
        .editor-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .editor-buttons .save-btn { background-color: #28a745; color: white; }
        .editor-buttons .cancel-btn { background-color: #6c757d; color: white; }

        /* æƒé™æ¨¡æ€æ¡†æ ·å¼ */
        #permissions-modal-content {
            text-align: left;
        }
        #permissions-modal-content input[type="text"] {
            width: calc(100% - 22px);
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .permission-rwx {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1em;
        }
        .permission-group {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        .permission-group label {
            display: block;
        }

        /* å‹ç¼©/è§£å‹æ¨¡æ€æ¡†æ ·å¼ */
        #compress-modal-content, #decompress-modal-content {
            text-align: left;
        }
        #compress-modal-content select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ–‡ä»¶ç®¡ç†å™¨</h1>
        <p><a href="{{ base_path }}/logout">é€€å‡ºç™»å½•</a></p>
        <div class="nav-buttons">
            <button onclick="location.href='{{ base_path }}/dashboard'">ä»ªè¡¨ç›˜</button>
            <button onclick="location.href='{{ base_path }}/file_manager'">æ–‡ä»¶ç®¡ç†</button>
            <button onclick="location.href='{{ base_path }}/process_manager'">è¿›ç¨‹ç®¡ç†</button>
            <button onclick="location.href='{{ base_path }}/terminal'">Webç»ˆç«¯</button>
            <button onclick="location.href='{{ base_path }}/systemd_manager'">å®šæ—¶ä»»åŠ¡</button>
            <button onclick="location.href='{{ base_path }}/screen_manager'">Screenä¼šè¯</button>
        </div>
        <h3 class="current-path" id="current-path">/</h3>

        <div id="bookmarks">
            <h4>ä¹¦ç­¾</h4>
            <div id="bookmark-list"></div>
        </div>

        <div class="file-actions">
            <input type="text" id="new-folder-name" placeholder="æ–°æ–‡ä»¶å¤¹åç§°">
            <button onclick="createFolder()">åˆ›å»ºæ–‡ä»¶å¤¹</button>
            <input type="file" id="fileUploadInput">
            <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
            <button onclick="createNewFile()">æ–°å»ºæ–‡ä»¶</button>
        </div>
        <div class="file-actions" style="margin-top: 10px;">
            <input type="text" id="search-query" placeholder="åœ¨å½“å‰ç›®å½•æœç´¢...">
            <button onclick="searchFiles()">æœç´¢</button>
            <button onclick="fetchFiles(currentPath, 1)">æ¸…é™¤æœç´¢</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å¤§å°</th>
                    <th>æœ€åä¿®æ”¹æ—¶é—´</th>
                    <th>æƒé™</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="file-list">
                <!-- æ–‡ä»¶åˆ—è¡¨å°†ç”±JavaScriptå¡«å…… -->
            </tbody>
        </table>
        <div class="pagination">
            <button id="prev-page-btn" disabled>ä¸Šä¸€é¡µ</button>
            <span id="page-info"></span>
            <button id="next-page-btn" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- æ–‡ä»¶ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="file-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditorModal()">&times;</span>
            <h2>ç¼–è¾‘æ–‡ä»¶: <span id="editing-file-path"></span></h2>
            <textarea id="editor-textarea"></textarea>
            <div class="editor-buttons">
                <button class="save-btn" onclick="saveFileContent()">ä¿å­˜</button>
                <button class="cancel-btn" onclick="closeEditorModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æƒé™è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="permissions-modal" class="modal">
        <div class="modal-content" id="permissions-modal-content">
            <span class="close-button" onclick="closePermissionsModal()">&times;</span>
            <h2>è®¾ç½®æƒé™: <span id="permissions-file-path"></span></h2>
            <label for="octal-permission">å…«è¿›åˆ¶æƒé™ (ä¾‹å¦‚: 755):</label>
            <input type="text" id="octal-permission" maxlength="4" pattern="[0-7]{3,4}" title="è¯·è¾“å…¥3æˆ–4ä½å…«è¿›åˆ¶æƒé™ç  (ä¾‹å¦‚ 755)">
            
            <div class="permission-rwx">
                <div class="permission-group">
                    <h4>æ‰€æœ‰è€… (Owner)</h4>
                    <label><input type="checkbox" id="owner-read"> è¯»å– (r)</label>
                    <label><input type="checkbox" id="owner-write"> å†™å…¥ (w)</label>
                    <label><input type="checkbox" id="owner-execute"> æ‰§è¡Œ (x)</label>
                </div>
                <div class="permission-group">
                    <h4>ç»„ (Group)</h4>
                    <label><input type="checkbox" id="group-read"> è¯»å– (r)</label>
                    <label><input type="checkbox" id="group-write"> å†™å…¥ (w)</label>
                    <label><input type="checkbox" id="group-execute"> æ‰§è¡Œ (x)</label>
                </div>
                <div class="permission-group">
                    <h4>å…¶ä»– (Others)</h4>
                    <label><input type="checkbox" id="others-read"> è¯»å– (r)</label>
                    <label><input type="checkbox" id="others-write"> å†™å…¥ (w)</label>
                    <label><input type="checkbox" id="others-execute"> æ‰§è¡Œ (x)</label>
                </div>
            </div>

            <div class="editor-buttons">
                <button class="save-btn" onclick="savePermissions()">ä¿å­˜</button>
                <button class="cancel-btn" onclick="closePermissionsModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å‹ç¼©æ¨¡æ€æ¡† -->
    <div id="compress-modal" class="modal">
        <div class="modal-content" id="compress-modal-content">
            <span class="close-button" onclick="closeCompressModal()">&times;</span>
            <h2>å‹ç¼©: <span id="compress-file-path"></span></h2>
            <label for="compress-format">é€‰æ‹©å‹ç¼©æ ¼å¼:</label>
            <select id="compress-format">
                <option value="zip">.zip</option>
                <option value="tar.gz">.tar.gz</option>
            </select>
            <div class="editor-buttons">
                <button class="save-btn" onclick="performCompress()">å‹ç¼©</button>
                <button class="cancel-btn" onclick="closeCompressModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è§£å‹æ¨¡æ€æ¡† -->
    <div id="decompress-modal" class="modal">
        <div class="modal-content" id="decompress-modal-content">
            <span class="close-button" onclick="closeDecompressModal()">&times;</span>
            <h2>è§£å‹: <span id="decompress-file-path"></span></h2>
            <p>æ–‡ä»¶å°†è§£å‹åˆ°å½“å‰ç›®å½•ã€‚</p>
            <div class="editor-buttons">
                <button class="save-btn" onclick="performDecompress()">è§£å‹</button>
                <button class="cancel-btn" onclick="closeDecompressModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const basePath = '{{ base_path }}';
        let currentEditingFilePath = ''; // ç”¨äºä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡ä»¶è·¯å¾„
        let currentPermissionsPath = ''; // ç”¨äºä¿å­˜å½“å‰è®¾ç½®æƒé™çš„æ–‡ä»¶è·¯å¾„
        let currentCompressPath = ''; // ç”¨äºä¿å­˜å½“å‰å‹ç¼©çš„æ–‡ä»¶/æ–‡ä»¶å¤¹è·¯å¾„
        let currentDecompressPath = ''; // ç”¨äºä¿å­˜å½“å‰è§£å‹çš„æ–‡ä»¶è·¯å¾„
        let currentPage = 1;
        let totalPages = 1;
        let currentPath = '';

        document.addEventListener('DOMContentLoaded', () => {
            fetchFiles('');
            fetchBookmarks();
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    fetchFiles(currentPath, currentPage - 1);
                }
            });
            document.getElementById('next-page-btn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    fetchFiles(currentPath, currentPage + 1);
                }
            });
            document.getElementById('search-query').addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    searchFiles();
                }
            });
        });

        function searchFiles() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹ã€‚');
                return;
            }
            fetchFiles(currentPath, 1, true, query);
        }

        async function fetchFiles(path, page = 1, search = false, query = '') {
            currentPath = path;
            currentPage = page;
            try {
                let url = '';
                if (search) {
                    url = `${basePath}/file_manager/files/search?query=${encodeURIComponent(query)}&path=${encodeURIComponent(path)}`;
                } else {
                    url = `${basePath}/file_manager/files?path=${encodeURIComponent(path)}&page=${page}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                const fileList = document.getElementById('file-list');
                const currentPathEl = document.getElementById('current-path');
                
                currentPathEl.textContent = `å½“å‰è·¯å¾„: ${data.current_full_path}`;
                fileList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨

                if (data.status === 'error') {
                    alert('é”™è¯¯: ' + data.message);
                    return;
                }

                const files = data.items;
                totalPages = data.total_pages;
                currentPage = data.current_page;

                updatePaginationControls(data.is_search_result);

                files.forEach(file => {
                    const row = fileList.insertRow();
                    
                    const nameCell = row.insertCell();
                    nameCell.className = 'file-item-name';
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = `${file.type === 'directory' ? 'ğŸ“' : 'ğŸ“„'} ${file.name}`;
                    if (file.type === 'directory') {
                        link.onclick = (e) => {
                            e.preventDefault();
                            fetchFiles(file.path, 1); // åˆ‡æ¢ç›®å½•æ—¶å›åˆ°ç¬¬ä¸€é¡µ
                        };
                    }
                    nameCell.appendChild(link);

                    row.insertCell().textContent = file.type === 'directory' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶';
                    row.insertCell().textContent = file.size !== null ? formatBytes(file.size) : 'N/A';
                    row.insertCell().textContent = file.last_modified ? new Date(file.last_modified).toLocaleString() : 'N/A';
                    row.insertCell().textContent = file.permissions ? file.permissions.slice(-3) : 'N/A'; // æ˜¾ç¤ºåä¸‰ä½å…«è¿›åˆ¶æƒé™

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-buttons';

                    if (file.type === 'file') {
                        const downloadButton = document.createElement('button');
                        downloadButton.textContent = 'ä¸‹è½½';
                        downloadButton.onclick = () => {
                            window.location.href = `${basePath}/file_manager/files/download?path=${encodeURIComponent(file.path)}`;
                        };
                        actionsCell.appendChild(downloadButton);

                        // ç®€å•çš„æ–‡æœ¬æ–‡ä»¶åˆ¤æ–­ï¼Œå¯æ ¹æ®å®é™…æ–‡ä»¶ç±»å‹æ‰©å±•
                        if (file.name.match(/\.(txt|log|conf|config|json|py|sh|js|css|html|xml|md)$/i)) {
                            const editButton = document.createElement('button');
                            editButton.textContent = 'ç¼–è¾‘';
                            editButton.onclick = () => openFileInEditor(file.path);
                            actionsCell.appendChild(editButton);
                        }

                        // åˆ¤æ–­æ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
                        if (file.name.match(/\.(zip|tar\.gz)$/i)) {
                            const decompressButton = document.createElement('button');
                            decompressButton.textContent = 'è§£å‹';
                            decompressButton.onclick = () => openDecompressModal(file.path);
                            actionsCell.appendChild(decompressButton);
                        }
                    }

                    if (file.type === 'directory' && file.name !== '..') {
                        const bookmarkButton = document.createElement('button');
                        bookmarkButton.textContent = 'â­';
                        bookmarkButton.title = 'æ·»åŠ ä¹¦ç­¾';
                        bookmarkButton.onclick = () => addBookmark(file.path);
                        actionsCell.appendChild(bookmarkButton);
                    }
                    
                    if (file.name !== '..') { // ä¸å…è®¸é‡å‘½åã€åˆ é™¤ã€è®¾ç½®â€œ..â€çš„æƒé™æˆ–å‹ç¼©
                        const renameButton = document.createElement('button');
                        renameButton.textContent = 'é‡å‘½å';
                        renameButton.onclick = () => renameFile(file.path, file.name);
                        actionsCell.appendChild(renameButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'åˆ é™¤';
                        deleteButton.className = 'delete-btn';
                        deleteButton.onclick = () => deleteFile(file.path);
                        actionsCell.appendChild(deleteButton);

                        const permissionsButton = document.createElement('button');
                        permissionsButton.textContent = 'æƒé™';
                        permissionsButton.onclick = () => openPermissionsModal(file.path);
                        actionsCell.appendChild(permissionsButton);

                        const compressButton = document.createElement('button');
                        compressButton.textContent = 'å‹ç¼©';
                        compressButton.onclick = () => openCompressModal(file.path);
                        actionsCell.appendChild(compressButton);
                    }
                });
            } catch (error) {
                console.error('Error fetching files:', error);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }
        
        function updatePaginationControls(is_search = false) {
            const paginationDiv = document.querySelector('.pagination');
            if (is_search) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'block';
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');

            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
        
        async function createFolder() {
            const folderNameInput = document.getElementById('new-folder-name');
            const folderName = folderNameInput.value.trim();
            const path = currentPath ? `${currentPath}/${folderName}` : folderName;

            if (!folderName) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ã€‚');
                return;
            }

            try {
                const response = await fetch(`${basePath}/file_manager/files/create_folder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    folderNameInput.value = '';
                    fetchFiles(currentPath);
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                alert('åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function renameFile(oldPath, oldName) {
            const newName = prompt(`è¾“å…¥æ–°çš„åç§°ï¼ŒåŸåç§°ä¸º "${oldName}":`, oldName);
            if (newName === null || newName.trim() === '' || newName === oldName) {
                return; // ç”¨æˆ·å–æ¶ˆæˆ–æœªåšæ›´æ”¹
            }
            
            const newPath = currentPath ? `${currentPath}/${newName.trim()}` : newName.trim();

            try {
                const response = await fetch(`${basePath}/file_manager/files/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_path: oldPath, new_path: newPath })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    fetchFiles(currentPath);
                } else {
                    alert('é‡å‘½åå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error renaming file:', error);
                alert('é‡å‘½åæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function deleteFile(path) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${path} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                return;
            }
            try {
                const response = await fetch(`${basePath}/file_manager/files/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    fetchFiles(currentPath);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                alert('åˆ é™¤æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileUploadInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ã€‚');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', currentPath);

            try {
                const response = await fetch(`${basePath}/file_manager/files/upload`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    fetchFiles(currentPath);
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('ä¸Šä¼ æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function createNewFile() {
            const fileName = prompt("è¯·è¾“å…¥æ–°æ–‡ä»¶çš„åç§° (ä¾‹å¦‚: new_file.txt):");
            if (fileName === null || fileName.trim() === '') {
                return;
            }

            const filePath = currentPath ? `${currentPath}/${fileName.trim()}` : fileName.trim();
            
            // å°è¯•åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶
            try {
                const response = await fetch(`${basePath}/file_manager/files/save_content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: filePath, content: '' }) // åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    fetchFiles(currentPath); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    // è‡ªåŠ¨æ‰“å¼€æ–°åˆ›å»ºçš„æ–‡ä»¶è¿›è¡Œç¼–è¾‘
                    openFileInEditor(filePath);
                } else {
                    alert('åˆ›å»ºæ–°æ–‡ä»¶å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating new file:', error);
                alert('åˆ›å»ºæ–°æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function openFileInEditor(filePath) {
            try {
                const response = await fetch(`${basePath}/file_manager/files/get_content?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('editing-file-path').textContent = filePath;
                    document.getElementById('editor-textarea').value = data.content;
                    currentEditingFilePath = filePath; // ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡ä»¶è·¯å¾„
                    
                    if (data.truncated) {
                        alert("æ–‡ä»¶è¿‡å¤§ï¼Œä»…æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹ä»¥ä¾›é¢„è§ˆã€‚ä¿å­˜æ“ä½œå°†è¦†ç›–æ•´ä¸ªæ–‡ä»¶ã€‚");
                    }

                    document.getElementById('file-editor-modal').style.display = 'block'; // æ˜¾ç¤ºæ¨¡æ€æ¡†
                } else {
                    alert('è¯»å–æ–‡ä»¶å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('Error opening file in editor:', error);
                alert('æ‰“å¼€æ–‡ä»¶ç¼–è¾‘å™¨æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function saveFileContent() {
            const content = document.getElementById('editor-textarea').value;
            if (!currentEditingFilePath) {
                alert('æ²¡æœ‰è¦ä¿å­˜çš„æ–‡ä»¶è·¯å¾„ã€‚');
                return;
            }

            try {
                const response = await fetch(`${basePath}/file_manager/files/save_content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentEditingFilePath, content: content })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    closeEditorModal(); // ä¿å­˜æˆåŠŸåå…³é—­ç¼–è¾‘å™¨
                    fetchFiles(currentPath); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ä»¥æ›´æ–°æ–‡ä»¶å¤§å°/ä¿®æ”¹æ—¶é—´
                } else {
                    alert('ä¿å­˜æ–‡ä»¶å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving file content:', error);
                alert('ä¿å­˜æ–‡ä»¶å†…å®¹æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        function closeEditorModal() {
            document.getElementById('file-editor-modal').style.display = 'none';
            document.getElementById('editor-textarea').value = ''; // æ¸…ç©ºå†…å®¹
            currentEditingFilePath = ''; // æ¸…ç©ºå½“å‰ç¼–è¾‘æ–‡ä»¶è·¯å¾„
        }

        // --- æƒé™ç®¡ç†åŠŸèƒ½ ---
        async function openPermissionsModal(filePath) {
            currentPermissionsPath = filePath;
            document.getElementById('permissions-file-path').textContent = filePath;
            document.getElementById('octal-permission').value = ''; // æ¸…ç©ºå…«è¿›åˆ¶è¾“å…¥æ¡†
            resetPermissionCheckboxes(); // æ¸…ç©ºå¤é€‰æ¡†

            try {
                const response = await fetch(`${basePath}/file_manager/files/permissions?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                if (data.status === 'success') {
                    const octal = data.permissions.slice(-3); // è·å–åä¸‰ä½å…«è¿›åˆ¶æƒé™
                    document.getElementById('octal-permission').value = octal;
                    updateCheckboxesFromOctal(octal);
                } else {
                    alert('è·å–æƒé™å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('Error fetching permissions:', error);
                alert('è·å–æƒé™æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
            document.getElementById('permissions-modal').style.display = 'block';
        }

        function closePermissionsModal() {
            document.getElementById('permissions-modal').style.display = 'none';
            currentPermissionsPath = '';
        }

        async function savePermissions() {
            const octalInput = document.getElementById('octal-permission').value.trim();
            if (!octalInput.match(/^[0-7]{3,4}$/)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„3æˆ–4ä½å…«è¿›åˆ¶æƒé™ç  (ä¾‹å¦‚ 755)ã€‚');
                return;
            }

            try {
                const response = await fetch(`${basePath}/file_manager/files/permissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentPermissionsPath, permissions: octalInput })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    closePermissionsModal();
                    fetchFiles(currentPath); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ä»¥æ›´æ–°æƒé™æ˜¾ç¤º
                } else {
                    alert('ä¿å­˜æƒé™å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving permissions:', error);
                alert('ä¿å­˜æƒé™æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        function octalToBinary(octal) {
            // å°†å…«è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸º9ä½äºŒè¿›åˆ¶å­—ç¬¦ä¸²
            return parseInt(octal, 8).toString(2).padStart(9, '0');
        }

        function binaryToOctal(binary) {
            // å°†9ä½äºŒè¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå…«è¿›åˆ¶
            return parseInt(binary, 2).toString(8).padStart(3, '0');
        }

        function updateCheckboxesFromOctal(octal) {
            resetPermissionCheckboxes();
            if (!octal || octal.length < 3) return;
            const binary = octalToBinary(octal.slice(-3)); // åªå–åä¸‰ä½

            const checkboxes = [
                document.getElementById('owner-read'), document.getElementById('owner-write'), document.getElementById('owner-execute'),
                document.getElementById('group-read'), document.getElementById('group-write'), document.getElementById('group-execute'),
                document.getElementById('others-read'), document.getElementById('others-write'), document.getElementById('others-execute')
            ];

            for (let i = 0; i < 9; i++) {
                checkboxes[i].checked = binary[i] === '1';
            }
        }

        function updateOctalFromCheckboxes() {
            const checkboxes = [
                document.getElementById('owner-read'), document.getElementById('owner-write'), document.getElementById('owner-execute'),
                document.getElementById('group-read'), document.getElementById('group-write'), document.getElementById('group-execute'),
                document.getElementById('others-read'), document.getElementById('others-write'), document.getElementById('others-execute')
            ];
            let binary = '';
            checkboxes.forEach(cb => {
                binary += cb.checked ? '1' : '0';
            });
            document.getElementById('octal-permission').value = binaryToOctal(binary);
        }

        function resetPermissionCheckboxes() {
            const checkboxes = [
                document.getElementById('owner-read'), document.getElementById('owner-write'), document.getElementById('owner-execute'),
                document.getElementById('group-read'), document.getElementById('group-write'), document.getElementById('group-execute'),
                document.getElementById('others-read'), document.getElementById('others-write'), document.getElementById('others-execute')
            ];
            checkboxes.forEach(cb => cb.checked = false);
        }

        // ç›‘å¬å…«è¿›åˆ¶è¾“å…¥æ¡†çš„å˜åŒ–
        document.getElementById('octal-permission').addEventListener('input', (event) => {
            const octal = event.target.value.trim();
            if (octal.match(/^[0-7]{3,4}$/)) {
                updateCheckboxesFromOctal(octal.slice(-3));
            } else {
                resetPermissionCheckboxes();
            }
        });

        // ç›‘å¬å¤é€‰æ¡†çš„å˜åŒ–
        document.querySelectorAll('.permission-group input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateOctalFromCheckboxes);
        });

        // --- å‹ç¼©/è§£å‹åŠŸèƒ½ ---
        async function openCompressModal(filePath) {
            currentCompressPath = filePath;
            document.getElementById('compress-file-path').textContent = filePath;
            document.getElementById('compress-modal').style.display = 'block';
        }

        function closeCompressModal() {
            document.getElementById('compress-modal').style.display = 'none';
            currentCompressPath = '';
        }

        async function performCompress() {
            const format = document.getElementById('compress-format').value;
            if (!currentCompressPath) {
                alert('æ²¡æœ‰è¦å‹ç¼©çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è·¯å¾„ã€‚');
                return;
            }

            try {
                const response = await fetch(`${basePath}/file_manager/files/compress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentCompressPath, format: format })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    closeCompressModal();
                    fetchFiles(currentPath); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                } else {
                    alert('å‹ç¼©å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error compressing file/folder:', error);
                alert('å‹ç¼©æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        async function openDecompressModal(filePath) {
            currentDecompressPath = filePath;
            document.getElementById('decompress-file-path').textContent = filePath;
            document.getElementById('decompress-modal').style.display = 'block';
        }

        function closeDecompressModal() {
            document.getElementById('decompress-modal').style.display = 'none';
            currentDecompressPath = '';
        }

        async function performDecompress() {
            if (!currentDecompressPath) {
                alert('æ²¡æœ‰è¦è§£å‹çš„æ–‡ä»¶è·¯å¾„ã€‚');
                return;
            }

            try {
                const response = await fetch(`${basePath}/file_manager/files/decompress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentDecompressPath }) // é»˜è®¤è§£å‹åˆ°å½“å‰ç›®å½•
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    closeDecompressModal();
                    fetchFiles(currentPath); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                } else {
                    alert('è§£å‹å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error decompressing file:', error);
                alert('è§£å‹æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // --- ä¹¦ç­¾åŠŸèƒ½ ---
        async function fetchBookmarks() {
            try {
                const response = await fetch(`${basePath}/file_manager/bookmarks`);
                const bookmarks = await response.json();
                const bookmarkListDiv = document.getElementById('bookmark-list');
                bookmarkListDiv.innerHTML = '';
                bookmarks.forEach(path => {
                    const bookmarkSpan = document.createElement('span');
                    bookmarkSpan.className = 'bookmark-item';
                    
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = path.split('/').pop() || path; // æ˜¾ç¤ºæœ€åä¸€éƒ¨åˆ†ä½œä¸ºåç§°
                    link.onclick = (e) => {
                        e.preventDefault();
                        fetchFiles(path, 1);
                    };

                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'delete-bookmark';
                    deleteBtn.textContent = 'x';
                    deleteBtn.title = 'åˆ é™¤ä¹¦ç­¾';
                    deleteBtn.onclick = () => deleteBookmark(path);

                    bookmarkSpan.appendChild(link);
                    bookmarkSpan.appendChild(deleteBtn);
                    bookmarkListDiv.appendChild(bookmarkSpan);
                });
            } catch (error) {
                console.error('Error fetching bookmarks:', error);
            }
        }

        async function addBookmark(path) {
            try {
                const response = await fetch(`${basePath}/file_manager/bookmarks/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    fetchBookmarks(); // é‡æ–°åŠ è½½ä¹¦ç­¾
                } else {
                    alert('æ·»åŠ ä¹¦ç­¾å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding bookmark:', error);
            }
        }

        async function deleteBookmark(path) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¹¦ç­¾ "${path}" å—ï¼Ÿ`)) {
                return;
            }
            try {
                const response = await fetch(`${basePath}/file_manager/bookmarks/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    fetchBookmarks(); // é‡æ–°åŠ è½½ä¹¦ç­¾
                } else {
                    alert('åˆ é™¤ä¹¦ç­¾å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting bookmark:', error);
            }
        }
    </script>
</body>
</html>
