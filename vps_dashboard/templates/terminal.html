<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web终端 - VPS-Lite-Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.11.0/css/xterm.css" />
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 1000px; margin: auto; background: #252526; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1 { color: #d4d4d4; }
        .nav-buttons { margin-bottom: 1em; }
        .nav-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: #007acc; color: white; margin-right: 10px; }
        .nav-buttons button:hover { background-color: #005a9e; }
        #terminal-container {
            width: 100%;
            height: calc(100vh - 250px); /* 动态调整高度 */
            min-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>VPS-Lite-Dashboard - Web终端</h1>
        <p>
            <a href="{{ base_path }}/logout">退出登录</a>
            <span style="float: right;">状态: <span id="status" style="background-color: #ff8383;">未连接</span></span>
        </p>
        <div class="nav-buttons">
            <button onclick="location.href='{{ base_path }}/dashboard'">仪表盘</button>
            <button onclick="location.href='{{ base_path }}/file_manager'">文件管理</button>
            <button onclick="location.href='{{ base_path }}/process_manager'">进程管理</button>
            <button onclick="location.href='{{ base_path }}/terminal'">Web终端</button>
            <button onclick="location.href='{{ base_path }}/systemd_manager'">定时任务</button>
        </div>

        <div id="terminal-container"></div>
    </div>

    <!-- 引入 Socket.IO 和 xterm.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/xterm@4.11.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const basePath = '{{ base_path }}';
            const terminalContainer = document.getElementById('terminal-container');
            const statusEl = document.getElementById('status');

            // 初始化 xterm.js
            const term = new Terminal({
                cursorBlink: true,
                macOptionIsMeta: true,
                scrollback: 1000,
            });
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(terminalContainer);
            fitAddon.fit();

            // 从 URL 获取 attach_screen 参数
            const urlParams = new URLSearchParams(window.location.search);
            const attachScreen = urlParams.get('attach_screen');

            const query = {};
            if (attachScreen) {
                query.attach_screen = attachScreen;
            }

            // 连接到 Socket.IO 服务器，并传递查询参数
            const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + '/pty', {
                path: `${basePath}/socket.io`,
                query: query
            });

            // --- Socket.IO 事件处理 ---
            socket.on('connect', () => {
                console.log('Connected to pty namespace.');
                statusEl.innerHTML = '<span style="background-color: lightgreen;">已连接</span>';
                fitToScreen(); // 连接成功后立即调整大小
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from pty namespace.');
                statusEl.innerHTML = '<span style="background-color: #ff8383;">已断开</span>';
            });

            socket.on('pty-output', (data) => {
                term.write(data.output);
            });

            // --- xterm.js 事件处理 ---
            term.onData((data) => {
                socket.emit("pty-input", { input: data });
            });

            // --- 窗口大小自适应 ---
            function fitToScreen() {
                try {
                    fitAddon.fit();
                    const dims = { cols: term.cols, rows: term.rows };
                    console.log("Sending new dimensions to server's pty:", dims);
                    socket.emit("resize", dims);
                } catch (e) {
                    console.error("Error on fit: ", e);
                }
            }

            function debounce(func, wait_ms) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait_ms);
                };
            }

            window.addEventListener('resize', debounce(fitToScreen, 50));
            fitToScreen(); // 初始加载时调整一次
        });
    </script>
</body>
</html>